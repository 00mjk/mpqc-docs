<!-- HTML header for doxygen 1.8.8-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <!-- For Mobile Devices -->
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
        <meta name="generator" content="Doxygen 1.8.20"/>
        <script type="text/javascript" src="https://code.jquery.com/jquery-2.1.1.min.js"></script>
        <title>MPQC: Running MPQC</title>
        <!--<link href="tabs.css" rel="stylesheet" type="text/css"/>-->
        <script type="text/javascript" src="dynsections.js"></script>
        <link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
  $(document).ready(function() { init_search(); });
/* @license-end */
</script>
        <link href="doxygen.css" rel="stylesheet" type="text/css" />
        <link href="customdoxygen.css" rel="stylesheet" type="text/css"/>
        <link href='https://fonts.googleapis.com/css?family=Roboto+Slab' rel='stylesheet' type='text/css'>
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css">
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>
        <link href="jquery.smartmenus.bootstrap.css" rel="stylesheet">
        <script type="text/javascript" src="jquery.smartmenus.js"></script>
        <!-- SmartMenus jQuery Bootstrap Addon -->
        <script type="text/javascript" src="jquery.smartmenus.bootstrap.js"></script>
        <!-- SmartMenus jQuery plugin -->
    </head>
    <body>
        <nav class="navbar navbar-default" role="navigation">
            <div class="container">
                <div class="navbar-header">
                    <a class="navbar-brand">MPQC 4.0.0-beta.1</a>
                </div>
            </div>
        </nav>
        <div id="top"><!-- do not remove this div, it is closed by doxygen! -->
            <div class="content" id="content">
                <div class="container">
                    <div class="row">
                        <div class="col-sm-12 panel " style="padding-bottom: 15px;">
                            <div style="margin-bottom: 15px;">
<!-- end header part -->
<!-- Generated by Doxygen 1.8.20 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Overview</span></a></li>
      <li><a href="intro.html"><span>Introduction</span></a></li>
      <li><a href="userguide.html"><span>User&#160;Guide</span></a></li>
      <li><a href="usergroup0.html"><span>Programmer&#160;Guides</span></a></li>
      <li><a href="usergroup1.html"><span>Source&#160;Reference</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.svg"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.svg" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Running MPQC </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>This chapter explains how to run MPQC in a variety of environments.</p>
<p>The first sections gives general information on running MPQC:</p>
<ul>
<li>
<a class="el" href="mpqcrunning.html#mpqccomline">Command Line Options</a> </li>
</ul>
<p>The final sections give specific information on running MPQC in different environments, as well as optimization hints:</p>
<ul>
<li>
<a class="el" href="mpqcrunning.html#mpqcmpi">Running on a Distributed Memory Multiprocessor with MPI</a> </li>
<li>
<a class="el" href="mpqcrunning.html#mpqcopthints">MPQC Optimization Hints</a> </li>
</ul>
<h1><a class="anchor" id="mpqccomline"></a>
Command Line Options</h1>
<p>MPQC executable can be given the following command-line options:</p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">option  </th><th class="markdownTableHeadNone">accept value?  </th><th class="markdownTableHeadNone">description   </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><code>-i</code>  </td><td class="markdownTableBodyNone">mandatory  </td><td class="markdownTableBodyNone">The name of the input file. MPQC will attempt to parse the given input file using the JSON, XML, and INFO formats (in that order). If <code>-i</code> is not given, and no options with omitted optional values are used (e.g., <code>-D</code>), the last command-line argument that does not specify an option will be assumed to give the input file name.   </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"><code>-o</code>  </td><td class="markdownTableBodyNone">mandatory  </td><td class="markdownTableBodyNone">The name of the file to which all output (including error) from rank 0 will be directed. By default MPQC sends (normal) output to the standard output and the error output to the standard error.   </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><code>-O</code>  </td><td class="markdownTableBodyNone">mandatory  </td><td class="markdownTableBodyNone">Same as <code>-o</code>, except keeps the output from all ranks. If # of MPI ranks is greater than 1 then the per-rank output from ranks other than 0 will be written to files with ".&lt;MPI rank&gt;" appended. All empty per-rank output files are removed at the end of the execution.   </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"><code>-p</code>  </td><td class="markdownTableBodyNone">mandatory  </td><td class="markdownTableBodyNone">The prefix for all relative file paths in the input file   </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><code>-W</code>  </td><td class="markdownTableBodyNone">mandatory  </td><td class="markdownTableBodyNone">the working directory in which to compute   </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"><code>-D</code>  </td><td class="markdownTableBodyNone">optional  </td><td class="markdownTableBodyNone">unless "debugger" keyword is given in input KeyVal, create a debugger at start, with the optional argument as its JSON KeyVal input   </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><code>-v</code>  </td><td class="markdownTableBodyNone">no  </td><td class="markdownTableBodyNone">print the version number and exit   </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"><code>-w</code>  </td><td class="markdownTableBodyNone">no  </td><td class="markdownTableBodyNone">print the warranty and exit   </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><code>-L</code>  </td><td class="markdownTableBodyNone">no  </td><td class="markdownTableBodyNone">print the license and exit   </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"><code>-k</code>  </td><td class="markdownTableBodyNone">no  </td><td class="markdownTableBodyNone">print all registered (KeyVal-constructible) DescribedClass classes   </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><code>-h</code>  </td><td class="markdownTableBodyNone">no  </td><td class="markdownTableBodyNone">print the usage info and exit   </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"><code>-d</code>  </td><td class="markdownTableBodyNone">no  </td><td class="markdownTableBodyNone">start the program and attach a debugger, if it is specified via the "debugger" keyword in the input, or via the <code>-D</code> option   </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><code>-t</code>  </td><td class="markdownTableBodyNone">no  </td><td class="markdownTableBodyNone">throw if a deprecated keyword is read   </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"><code>-meminfo</code>  </td><td class="markdownTableBodyNone">no  </td><td class="markdownTableBodyNone">enable MADWorld's <code>print_meminfo</code> memory profiler   </td></tr>
</table>
<h2><a class="anchor" id="mpqccomlineexamples"></a>
MPQC Usage Examples</h2>
<ol>
<li>
prints the usage info: <div class="fragment"><div class="line">mpqc -h</div>
</div><!-- fragment --> </li>
<li>
run MPQC using <code>input.json</code> as the input file: <div class="fragment"><div class="line">mpqc input.json</div>
</div><!-- fragment --> </li>
<li>
same as 2, but launches debugger upon failure using the default method (if the <code>DISPLAY</code> environment variable is defined, launches <code>gdb</code> or <code>lldb</code> via <code>xterm</code>, otherwise spins waiting for the user to attach debugger to each process): <div class="fragment"><div class="line">mpqc -D &#39;{&quot;cmd&quot;: &quot;gdb_xterm&quot;}&#39; input.json</div>
</div><!-- fragment --> </li>
<li>
same as 2, but launches <code>gdb</code> via <code>xterm</code> upon failure: <div class="fragment"><div class="line">mpqc -D &#39;{&quot;cmd&quot;: &quot;gdb_xterm&quot;}&#39; input.json</div>
</div><!-- fragment --> </li>
<li>
same as 2, but launches <code>lldb</code> via <code>xterm</code> upon failure: <div class="fragment"><div class="line">mpqc -D &#39;{&quot;cmd&quot;: &quot;lldb_xterm&quot;}&#39; input.json</div>
</div><!-- fragment --> </li>
<li>
same as 2, but <b>broken</b> since <code>-D</code> "consumes" <code>input.json</code> as its argument: <div class="fragment"><div class="line">mpqc -D input.json</div>
</div><!-- fragment --> </li>
<li>
fixed version of 6, <code>input.json</code> is passed via <code>-i</code>: <div class="fragment"><div class="line">mpqc -D -i input.json</div>
</div><!-- fragment --> </li>
<li>
same as 5, but redirects output to <code>output.log</code>': <div class="fragment"><div class="line">mpqc -d -D &#39;{&quot;cmd&quot;: &quot;lldb_xterm&quot;}&#39; -o output.log input.json</div>
</div><!-- fragment --> </li>
</ol>
<h1><a class="anchor" id="mpqcenv"></a>
MPQC Environment Variables</h1>
<ul>
<li><code>MPQC_WORK_DIR</code>: the directory for POSIX I/O of large text/binary files; it needs to be valid in every MPI process; the default on each process is the current working directory of that MPI process</li>
</ul>
<h1><a class="anchor" id="mpqcmpi"></a>
Running on a Distributed Memory Multiprocessor with MPI</h1>
<p>MPQC requires a high-performance MPI implementation that supports <code>MPI_THREAD_MULTIPLE</code> operation. Modern MPI implementations expose a huge number of parameters that can be controlled by user via environment variables or other means. Correct execution of MPQC with most MPI implementations usually does not require changing any parameters; the few exceptions are listed below.</p>
<h2><a class="anchor" id="mpqcmpimvapich2"></a>
MVAPICH2</h2>
<p>Environment variables <code>MV2_ENABLE_AFFINITY</code> and <code>MV2_USE_LAZY_MEM_UNREGISTER</code> must be both set to zero, e.g.: </p><div class="fragment"><div class="line">export MV2_ENABLE_AFFINITY=0</div>
<div class="line">export MV2_USE_LAZY_MEM_UNREGISTER=0</div>
</div><!-- fragment --><h2><a class="anchor" id="mpqcmpiopenmpi"></a>
OpenMPI</h2>
<p>When running with OpenMPI with 1 MPI rank per node the default is to bind all threads to 1 core. This is clearly suboptimal. The simplest solution is to provide <code>&ndash;bind-to none</code> to <code>mpirun</code>, however that may not be optimal either. The user should refer to <a href="https://www.open-mpi.org/doc/current/man1/mpirun.1.php#toc2">OpenMPI mpirun documentation</a> to understand how to pin threads appropriately.</p>
<h1><a class="anchor" id="mpqcopthints"></a>
MPQC Optimization Hints</h1>
<p>MPQC was designed to execute correctly and efficiently on a typical platform without too much user intervention. To achieve optimal performance, however, manual tuning is necessary.</p>
<h2><a class="anchor" id="mpqcopthintsthr"></a>
Number of MADWorld Threads</h2>
<p>The total number of MADWorld threads by default is set to the number of available cores (this may be affected by whether hyperthreading is enabled or not). Of these one thread will always be used for messaging (note that this is distinct from MPI threads; modern MPI implementations will typically use one or more threads for their own messaging operations) and the rest will be used for computation. Environment variable <code>MAD_NUM_THREADS</code> can be used to control the total number of threads used by MADWorld. It is recommended to set it to the number of hardware threads that each MPI rank can access without contention (e.g. the number of cores in each physical node).</p>
<p>N.B. The actual number of threads created by MADWorld may be greater than the value given by <code>MAD_NUM_THREADS</code>, however the total number of active threads will exceed its value. This also assumes that user tasks are single-threaded (i.e. do not spin their own threads).</p>
<h2><a class="anchor" id="mpqcopthintsbuf"></a>
Communication Buffers</h2>
<p>It is recommended to increase the number and size of communication buffers used by the active messaging system of MADWorld runtime. The following environment variables can be used to control the active messaging:</p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Environment Variable  </th><th class="markdownTableHeadNone">Description   </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><code>MAD_SEND_BUFFERS</code>  </td><td class="markdownTableBodyNone">The number of buffers that track pending outgoing messages. The default value depends on the platform; <code>MAD_SEND_BUFFERS=128</code> by default for Linux and MacOS.   </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"><code>MAD_RECV_BUFFERS</code>  </td><td class="markdownTableBodyNone">The number of preallocated buffers for receiving incoming messages <em>eagerly</em>. The default value is <code>MAD_RECV_BUFFERS=128</code>.   </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><code>MAD_BUFFER_SIZE</code>  </td><td class="markdownTableBodyNone">The size of each preallocated buffer for receiving incoming messages eagerly. The default is <code>MAD_RECV_BUFFERS=1.5MB</code>.   </td></tr>
</table>
<p>The most important factor for performance is the receive buffer size: TA Arrays' tiles must fit into these buffers to ensure best performance. For data that exceeds the eager buffer size a rendevous protocol will be used which will increases messaging latency and thus will can significantly impact message processing and overall performance.</p>
<h2><a class="anchor" id="mpqcopthintsmpi"></a>
MPI Ranks per node</h2>
<p>Although in an ideal scenario one MPI rank per node is optimal for intra-node communication efficiency, in practice better performance may be obtained by using more than 1 MPI rank per node. Two factor play into this: (1) communication thread performance and (2) NUMA regions. The former determines whether single communication thread can process incoming messages at a rate sufficient to keep compute threads busy. On massively multicore machines such as Intel Xeon Phi one communication thread is not sufficient, so it is better to use more 1 MPI rank per node (this is only applicable if using more than 1 node). NUMA regions also factor into this. Since MADWorld and <a class="el" href="namespace_tiled_array.html">TiledArray</a> do not assume any structure about the memory accessed by a single MPI rank, to improve memory locality in presence of NUMA regions it is recommended to create 1 MPI rank per NUMA region (e.g. 1 per socket in a multisocket CPU node, or 1 per NUMA region on Xeon Phi), and bind that rank's threads to its region. See your MPI implementation documentation for how to bind threads to NUMA regions.</p>
<h2><a class="anchor" id="mpqcopthintsblaslapack"></a>
BLAS/LAPACK Library</h2>
<p>It is recommended to use sequential BLAS/LAPACK library interfaces. N.B. It should be possible to use multithreaded versions of MKL that use Intell Thread Building Blocks (TBB) correctly assuming that MADWorld also uses TBB. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->

<!-- HTML footer for doxygen 1.8.8-->
<!-- start footer part -->
</div>
</div>
</div>
</div>
</div>
<hr class="footer"/><address class="footer"><small>
    Generated at Fri Feb 12 2021 13:12:41 for <a href="http://www.mpqc.org">MPQC</a>
    4.0.0-beta.1 by &#160;<a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.20
</small></address>
</body>
<script type="text/javascript" src="doxy-boot.js"></script>
</html>
